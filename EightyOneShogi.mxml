<?xml version="1.0" encoding="utf-8"?>
<mx:Application xmlns:mx="http://www.adobe.com/2006/mxml" layout="absolute" backgroundColor="0xcccc77" creationComplete="{initApp()}" xmlns:eightyOneSquare="*" frameRate="24">
	<mx:Style>
		Alert {
			fontSize : 13px;
		}
	</mx:Style>
	<mx:Script>
    <![CDATA[
    import flash.display.*;
	import flash.events.Event;
	import flash.events.MouseEvent;
	import flash.events.TimerEvent;
	import flash.media.SoundTransform;
	import flash.net.FileReference;
	import flash.net.URLVariables;
	import flash.ui.Mouse;
	import flash.utils.Timer;
    import mx.events.FlexEvent;
    import mx.events.CloseEvent;
    import flash.media.Sound;
    import mx.controls.*;
    import mx.managers.PopUpManager;
    import mx.core.IFlexDisplayObject;
	import com.web2memo.text.Jcode;
    import CsaShogiClient;
	import ApiClient;
	import InfoFetcher;
    import Board;
	import GameTimer;
    import ChallengeForm;
    import GameRuleEvent;
    import mx.utils.StringUtil;
	
	private const VERSION:String = "ver.2010/10/25";

    private var _client:CsaShogiClient;
	private var _api:ApiClient;
    [Bindable]
    private var _game_name:String;
    private var _user_list:Array;
	private var _waiter_list:Array;
	private var _game_list:Array;
	private var _kifu_search_list:Array;
	private var _player_search_list:Array;
	private var _ranking_rate_list:Array;
	private var _ranking_wins_list:Array;
	private var _ranking_total_list:Array;
	private var _ranking_percentage_list:Array;
	private var _ranking_streak_list:Array;
    private var _login_name:String;
	private var _player_infos:Array = new Array;
	private var _watch_game:Object;
    private var _monitoring:Boolean;
	private var _waiting:Boolean = false;
    private var _challenging:Boolean = false;
	[Bindable]
	private var _lastChatTime:String;

    [Embed(source = "/sound/win.mp3")]
    private var Sound_win:Class;
    private var _sound_win:Sound = new Sound_win();
    [Embed(source = "/sound/lose.mp3")]
    private var Sound_lose:Class;
    private var _sound_lose:Sound = new Sound_lose();
    [Embed(source = "/sound/chat_board.mp3")]
    private var Sound_chat1:Class;
    private var _sound_chat1:Sound = new Sound_chat1();
    [Embed(source = "/sound/chat_board.mp3")]
    private var Sound_chat2:Class;
    private var _sound_chat2:Sound = new Sound_chat2();
    [Embed(source = "/sound/chat_namecall.mp3")]
    private var Sound_chat3:Class;
    private var _sound_chat3:Sound = new Sound_chat3();
    [Embed(source = "/sound/chat_lobby.mp3")]
    private var Sound_chat4:Class;
    private var _sound_chat4:Sound = new Sound_chat4();
    [Embed(source = "/sound/challenger.mp3")]
    private var Sound_challenger:Class;
    private var _sound_challenger:Sound = new Sound_challenger();
    private var _end_sound_play:Boolean = true;
    private var _chat_sound1_play:Boolean = true;
    private var _chat_sound2_play:Boolean = true;
	private var _chat_auto_scroll1:Boolean = true;
	private var _chat_auto_scroll2:Boolean = true;
	private var _regExpCalled:RegExp;
	private var _ur_total_selected:int = 3;
	private var _ur_byoyomi_selected:int = 4;
	private var _ur_handicap_selected:int = 0;
	private var _userMessageScrollPos1:int;
	private var _userMessageScrollPos2:int;
	private var _initPositionStr:String;
    private var _keepAliveTimer:Timer;
	private var _challengerTicker:Timer;
	private var _infoFetcher:InfoFetcher;
	
    private var _optionWindow:OptionDialog;
	private var _newGameWindow:NewGameForm; 
    private var _playerInfoWindow:PlayerInfoWindow;
	private var _challengerAlertWindow:ChallengerAlertWindow;
	private var _gameResultWindow:GameResultWindow;

    private function initApp():void
    {
      trace("application initialized..");
	  boardBox.addEventListener(MouseEvent.ROLL_OUT, _rollOut);
	  boardBox.addEventListener(MouseEvent.ROLL_OVER, _rollOver);
      _client = new CsaShogiClient();
	  _api = new ApiClient();
      board.setMoveCallback(_playerMove);
      board.setTimeoutCallback(_checkTimeout);
      chatMessage1.addEventListener(FlexEvent.ENTER,_handleSendChat1);
      chatMessage2.addEventListener(FlexEvent.ENTER,_handleSendChat2);
      loginname.addEventListener(FlexEvent.ENTER,_handleLogin);
      password.addEventListener(FlexEvent.ENTER, _handleLogin);
	  board.name_labels[0].addEventListener(MouseEvent.DOUBLE_CLICK, _gamePlayerInfo);
	  board.name_labels[1].addEventListener(MouseEvent.DOUBLE_CLICK, _gamePlayerInfo);
	  _challengerTicker = new Timer(1000);
	  _challengerTicker.addEventListener(TimerEvent.TIMER, _challengerTickHandler);
	  _infoFetcher = new InfoFetcher();
      _user_list = new Array();
      userListGrid.dataProvider = _user_list;
    }

    private function _connectAndLogin():void{
      trace("connecting.");
      _client.addEventListener(CsaShogiClient.CONNECTED,_handleConnected);
      _client.addEventListener(CsaShogiClient.LOGIN,_handleLoggedIn);
      _client.addEventListener(CsaShogiClient.LOGIN_FAILED, _handleLoginFailed);
	  _client.addEventListener(CsaShogiClient.LOGOUT_COMPLETED, _handleLogout);
      _client.addEventListener(CsaShogiClient.GAME_STARTED,_handleGameStarted);
      _client.addEventListener(CsaShogiClient.GAME_END,_handleGameEnd);
      _client.addEventListener(CsaShogiClient.CHAT, _handleChat);
	  _client.addEventListener(CsaShogiClient.GAMECHAT, _handleGameChat);
	  _client.addEventListener(CsaShogiClient.PRIVATECHAT, _handlePrivateChat);
      _client.addEventListener(CsaShogiClient.MOVE,_handleMove);
      _client.addEventListener(CsaShogiClient.WHO,_handleWho);
      _client.addEventListener(CsaShogiClient.MONITOR,_handleMonitor);
      _client.addEventListener(CsaShogiClient.LIST, _handleList);
      _client.addEventListener(CsaShogiClient.GAME_SUMMARY, _handleGameSummary);
      _client.addEventListener(CsaShogiClient.REJECT, _handleReject);
      _client.addEventListener(CsaShogiClient.WATCHERS, _handleWatchers);
	  _api.addEventListener(ApiClient.KIFU_SEARCH, _handleKifuSearch);
	  _api.addEventListener(ApiClient.KIFU_DETAIL, _handleKifuDetail);
	  _api.addEventListener(ApiClient.PLAYER_SEARCH, _handlePlayerSearch);
	  _api.addEventListener(ApiClient.RANKING_SEARCH, _handleRankingSearch);
      loginMessage.text = "Connecting...";
      errorMessage.text = "";
      _client.connect();
    }
	
	private function _rollOver(e:MouseEvent):void {
//		if (_isPlayer() && !board.viewing && _game_name.split("+")[1].match(/^r_/)) _client.gameChat(_game_name, "[##M_IN]");
	}
	
	private function _rollOut(e:MouseEvent):void {
//		if (_isPlayer() && !board.viewing && _game_name.split("+")[1].match(/^r_/)) _client.gameChat(_game_name, "[##M_OUT]");
	}

    private function _handleKeepAlive(e:Event):void {
	  _refresh();
    }

    private function _handleLogin(e:Event):void{
      _connectAndLogin();
    }
	
	private function _testLogin(i:int):void {
		loginname.text = "test" + i;
		password.text = "81dojo" + i;
		_connectAndLogin();
	}
	
	private function _localLogin():void {
		_client.setHostToLocal();
		_api.setHostToLocal();
		loginButton.setStyle('color', '0xFF0000');
		loginButton.setStyle('textRollOverColor', '0xFF0000');
	}
	
	private function _logout():void {
//		_sendAutoChat("I've logged out. See you.");
		_client.logout();
	}
	
	private function _handleLogout(e:ServerMessageEvent):void {
		_keepAliveTimer.stop();
		loginMessage.text = "logged out successfully";
		titleBanner.source = "http://www.81squareuniverse.com/dojo/images/81Dojo_bye.jpg";
		loginButton.enabled = false;
		mainViewStack.selectedIndex = 0;
	}
    
    private function _handleConnected(e:Event):void{
      loginMessage.text = "Logging in...";
      _client.login(loginname.text, password.text);
      _login_name = loginname.text;
	  _regExpCalled = new RegExp("@" + _login_name.toLowerCase(), "i");
    } 

    private function _handleLoggedIn(e:Event):void{
      loginMessage.text = "Logged in Successfully";
      mainViewStack.selectedIndex = 1;
	  _infoFetcher.addEventListener("loadComplete", _handleLoadOption);
	  _infoFetcher.loadSettings(_login_name.toLowerCase());
      _keepAliveTimer = new Timer(30000);
      _keepAliveTimer.addEventListener(TimerEvent.TIMER,_handleKeepAlive);
	  _refresh();
	  _writeUserMessage(_infoFetcher.initMessage + "\n\n", 1, "#008800");
	  if (VERSION != _infoFetcher.newestVer) _writeUserMessage("CAUTION: This version is old! The newest is " + _infoFetcher.newestVer + ". Please reload!\n", 1, "#FF0000");
	  _sendAutoChat("I've logged in. Hello.");
    }

    private function _handleLoginFailed(e:ServerMessageEvent):void{
      loginMessage.text = "";
      errorMessage.text = e.message;
    }

    private function _handleChat(e:ServerMessageEvent):void{
		if (e.message.match(/\[auto\-chat\]/)) {
			_writeUserMessage(e.message.substr(8), 1, "#888888");
		} else if (e.message.match(_regExpCalled)) {
			_writeUserMessage(e.message.substr(8), 1, "#FF0000");
		} else if (e.message.substr(8).match(/^\[(.+?)\]\s.*$/)[1] == _login_name) {
			_writeUserMessage(e.message.substr(8), 1, "#0033DD");
		} else {
			_writeUserMessage(e.message.substr(8), 1, "#000000");
		}
		if (mainViewStack.selectedIndex == 1 && _chat_sound1_play) {
			if (e.message.match(/\[auto\-chat\]/)) {
				_sound_chat4.play();
			} else if (e.message.match(_regExpCalled)) {
				_sound_chat3.play();
			} else {
				_sound_chat1.play();
			}
		}
	}
	
    private function _handleGameChat(e:ServerMessageEvent):void {
		var match:Array;
		if ((match = e.message.match(/\[\#\#STUDY\](\d+)\/(.+)$/))) {
			board.studyOrigin = match[1];
			if (match[2] == "*") {
				if (board.study_list.length > 0) board.study_list = new Array();
				if (!board.isWinner && !(board.post_game && board.onListen)) return;
				kifuDataGrid.selectedIndex = match[1];
				board.replayMoves(match[1]);
				kifuDataGrid.scrollToIndex(kifuDataGrid.selectedIndex);
			} else {
				board.study_list = match[2].split("/");
				if (!board.isWinner && !(board.post_game && board.onListen)) return;
				kifuDataGrid.selectedIndex = match[1];
				board.replayMoves(match[1]);
				kifuDataGrid.scrollToIndex(kifuDataGrid.selectedIndex);
				for (var i:int = 0; i < board.study_list.length; i++) board.makeMove(board.study_list[i] + ",T0", false);
			}
		} else if ((match = e.message.substr(12).match(/^\[(.+)\]\s\[##M_(IN|OUT)\]$/))) {
			trace(match[1] + "-" + match[2]);
		} else {
			if (e.message.match(_regExpCalled)) {
				_writeUserMessage(e.message.substr(12), 2, "#FF0000");
			} else if (e.message.substr(12).match(/^\[(.+?)\]\s.*$/)[1] == board.playerInfos[0].name) {
				_writeUserMessage(e.message.substr(12), 2, "#000000");
			} else if (e.message.substr(12).match(/^\[(.+?)\]\s.*$/)[1] == board.playerInfos[1].name) {
				_writeUserMessage(e.message.substr(12), 2, "#666666");
			} else if (e.message.substr(12).match(/^\[(.+?)\]\s.*$/)[1] == _login_name) {
				_writeUserMessage(e.message.substr(12), 2, "#0033DD");
			} else {
				_writeUserMessage(e.message.substr(12), 2, "#660000");
			}
			if (_chat_sound2_play){
				if (e.message.match(_regExpCalled)) {
					_sound_chat3.play();
				} else {
					_sound_chat1.play();
				}
			}
		}
    }
	
	private function _handlePrivateChat(e:ServerMessageEvent):void {
		if (mainViewStack.selectedIndex == 1) {
			_writeUserMessage("PM: " + e.message.substr(15), 1, "#FF0000");
		} else if (mainViewStack.selectedIndex == 2) {
			_writeUserMessage("PM: " + e.message.substr(15), 2, "#FF0000");
		}
		if (_chat_sound1_play) _sound_chat3.play();
	}

    private function _format_message(message:String):String{
      message = message.substr(8);
      var match:Array = message.match(/(\[.+?\]) ([^ ]+?\+[^ ]+?\-[0-9]+?\-[0-9]+?\+[^ ]+?\+[^ ]+?\+[0-9]*) (.*)/);
      if(match != null){
        message = match[1] + " " + match[3] + "\n";
      }
      return message;
    }

    private function _handleMove(e:ServerMessageEvent):void {
      board.makeMove(e.message);
      kifuDataGrid.dataProvider = board.kifu_list;
      kifuDataGrid.scrollToIndex(board.kifu_list.length+1);
    }
  
  private function _handleGameSummary(e:ServerMessageEvent):void {
	  _initPositionStr = "";
	  for each(var line:String in e.message.split("\n")) {
		  if (line.match(/^P[0-9\+\-]/)) _initPositionStr += line + "\n";
	  }
    if (_challenging) {
      _client.agree();
    } else {
	  _refresh();
	  var challengerName:String = _login_name == e.message.split("\n")[0] ? e.message.split("\n")[1] : e.message.split("\n")[0];
      _sound_challenger.play();
	  _challengerTicker.reset();
	  _challengerTicker.start();
      _challengerAlertWindow = ChallengerAlertWindow(PopUpManager.createPopUp(this, ChallengerAlertWindow, true));
      PopUpManager.centerPopUp(_challengerAlertWindow);
      with(_challengerAlertWindow){
        title = "Here comes a new challenger!!";
		remainTime = 20;
		user = _findPlayerFromList(challengerName);
        acceptButton.addEventListener("click", _handleChallengerAcceptButton);
		rejectButton.addEventListener("click", _handleChallengerRejectButton);
      }
    }
  }
  
  private function _handleChallengerAcceptButton(e:MouseEvent):void {
	  _challengerTicker.reset();
	  _client.agree();
  }
  
  private function _handleChallengerRejectButton(e:MouseEvent):void {
	  _challengerTicker.reset();
	  _client.reject();
  }
	
	private function _challengerTickHandler(e:TimerEvent):void {
		_challengerAlertWindow.remainTime -= 1
		if (_challengerAlertWindow.remainTime <= 0) {
			_challengerTicker.reset();
			_client.reject();
			PopUpManager.removePopUp(_challengerAlertWindow);
		}
	}
  
  private function _handleReject(e:ServerMessageEvent):void {
	if (_challenging) {
		_writeUserMessage("Rejected by the opponent.\n", 1, "#008800");
		_challenging = false;
	}
	if (_waiting) {
		_client.waitAgain();
		stopButton.enabled = true;
	}
  }

    private function _handleWatchers(e:ServerMessageEvent):void{
      var watchers:Array = e.message.split("\n");
      var watcher_list:Array = new Array();
      for each(var watcher_data:String in watchers){
        if(watcher_data.match(/^##\[WATCHERS\] \+OK$/)){
          break;
        }
        var watcher:Object = new Object();
        var match:Array = watcher_data.match(/^##\[WATCHERS\] (.*) (\d+) (\d+)$/);
        if(match){
          watcher.name = match[1];
		  watcher.rating = parseInt(match[2]);
		  watcher.country3 = _infoFetcher.country_names3[parseInt(match[3])];
		  watcher.country = _infoFetcher.country_names[parseInt(match[3])];
          watcher_list.unshift(watcher);
        }
      }
      watcherListGrid.dataProvider = watcher_list;
	  watcherListTitle.text = "Watchers (" + watcher_list.length +")";
    }

    private function _handleGameStarted(e:ServerMessageEvent):void {
	  _waiting = false;
	  _challenging = false;
	  if(_game_name && _monitoring){
        _client.monitorOff(_game_name);
        _monitoring = false;
		board.closeGame();
      }
	  board.post_game = false;
	  board.isWinner = false;
	  board.isLoser = false;
	  for (var j:int = 0; j < 2 ; j++) {
		_player_infos[j] = _findPlayerFromList(_client.playerNames[j]);
	  }
      var match:Array = e.message.match(/^START:(.*)\+(.*)-([0-9]*)-([0-9]*)/);
      _game_name = e.message.substr(6);
	  if (_game_name.split("+")[1].match(/^hc/)) {
		  board.superior = Kyokumen.GOTE;
	  } else if (_player_infos[0].rating > _player_infos[1].rating) {
		  board.superior = Kyokumen.SENTE;
	  } else {
		  board.superior = Kyokumen.GOTE;
	  }
      board.startGame(_initPositionStr, _client.myTurn, _player_infos,match[3], match[4]);
	  _client.watchers(_game_name);
      userMessage2.htmlText = "";
	  _writeUserMessage(_infoFetcher.gameMessage + "\n\n", 2, "#008800");
      if(_client.myTurn == Kyokumen.SENTE){
        _writeUserMessage("You are Black " + (_game_name.split("+")[1].match(/^hc/) ? "(Handicap taker).\n" : "(Sente).\n"), 2, "#008800");
      } else {
        _writeUserMessage("You are White " + (_game_name.split("+")[1].match(/^hc/) ? "(Handicap giver).\n" : "(Gote).\n"), 2, "#008800");
      }
	  startButton.enabled = false;
      stopButton.enabled = false;
      closeButton.enabled = false;
      resignButton.enabled = true;
      rewindAllButton.enabled = false;
      rewindOneButton.enabled = false;
      forwardOneButton.enabled = false;
      forwardAllButton.enabled = false;
      kifuDataGrid.selectable = false;
	  logoutButton.enabled = false;
      kifuDataGrid.dataProvider = board.kifu_list;
      mainViewStack.selectedIndex = 2;
	  radioKifuListen.selected = true;
	  radioKifuListen.enabled = false;
	  radioKifuReplay.enabled = false;
	  board.onListen = true;
    }

    private function _handleGameEnd(e:ServerMessageEvent):void {
      var kifuMove:Object = new Object();
	  board.post_game = true;
      kifuMove.num = board.kifu_list.length;
      if(e.message.indexOf("TIME_UP") >= 0){
        board.timeout();
        //_writeUserMessage("Time up.\n",2);
		if (board.position.turn == board.my_turn) _sendAutoChat("Time out.");
        kifuMove.move = (board.position.turn == Kyokumen.SENTE ? "▲" : "△") + "Time up";
        kifuMove.moveKIF = "切れ負け";
        board.kifu_list.push(kifuMove);
	  } else if (e.message.indexOf("DISCONNECT") >= 0) {
        _writeUserMessage("Opponent disconnected.\n", 2, "#DD0088");
      } else if(e.message.indexOf("ILLEGAL_MOVE") >= 0){
        _writeUserMessage("Illegal Move.\n", 2, "#DD0088");
          kifuMove.move = "Illegal Move";
          kifuMove.moveKIF = "相手の反則にて勝ち";
          board.kifu_list.push(kifuMove);
      } else if (e.message.indexOf("RESIGN") >= 0) {
        _writeUserMessage((board.position.turn == board.my_turn ? "You" : "Opponent") + " resigned.\n", 2, "#DD0088");
//		if (board.position.turn == board.my_turn) _sendAutoChat("I resign.");
        kifuMove.move = (board.position.turn == Kyokumen.SENTE ? "▲" : "△") + "Resign";
        kifuMove.moveKIF = "投了";
        board.kifu_list.push(kifuMove);
      } else if (e.message.indexOf("OUTE_SENNICHITE") >= 0) {
        _writeUserMessage("Illegal Perpetual Check.\n", 2, "#DD0088");
		kifuMove.move = "Perpetual Check";
		kifuMove.moveKIF = "王手千日手";
		board.kifu_list.push(kifuMove);
      } else if (e.message.indexOf("SENNICHITE") >= 0) {
        _writeUserMessage("Sennichite. (Repetition)\n", 2, "#DD0088");
		kifuMove.move = "Repetition Draw";
		kifuMove.moveKIF = "千日手";
		board.kifu_list.push(kifuMove);
      }
	  radioKifuReplay.enabled = true;
	  radioKifuReplay.selected = true;
	  board.onListen = false;
      if (e.message.indexOf("LOSE") >= 0) {
		board.isWinner = false;
		board.isLoser = true;
		radioKifuListen.enabled = true;
		_openGameResultWindow(-1);
        _writeUserMessage("### You Lose ###\n", 2, "#DD0088");
        if (_end_sound_play) _sound_lose.play();
      } else if (e.message.indexOf("WIN") >= 0) {
		board.isWinner = true;
		board.isLoser = false;
		board.studyOrigin = kifuMove.num;
		_openGameResultWindow(1);
        _writeUserMessage("### You Win ###\n", 2, "#DD0088", true);
        if (_end_sound_play) _sound_win.play();
      } else if (e.message.indexOf("DRAW") >= 0) {
		board.isWinner = false;
		board.isLoser = false;
		radioKifuListen.enabled = true;
		_openGameResultWindow(0);
        _writeUserMessage("### Draw ###\n", 2, "#DD0088");
        if (_end_sound_play) _sound_win.play();
      }
      closeButton.enabled = true;
      resignButton.enabled = false;
      kifuCopyButton.enabled = true;
	  kifuSaveButton.enabled = true;
      rewindAllButton.enabled = true;
      rewindOneButton.enabled = true;
      forwardOneButton.enabled = true;
      forwardAllButton.enabled = true;
	  startButton.enabled = true;
      kifuDataGrid.dataProvider = board.kifu_list;
      kifuDataGrid.scrollToIndex(board.kifu_list.length+1);
      kifuDataGrid.selectable = true;
      kifuDataGrid.selectedIndex = board.kifu_list.length;
      board.endGame();
    }
	
	private function _openGameResultWindow(v:int):void {
	  _gameResultWindow = GameResultWindow(PopUpManager.createPopUp(this, GameResultWindow, false));
      PopUpManager.centerPopUp(_gameResultWindow);
	  _gameResultWindow.initWindow(board.playerInfos[board.my_turn], board.playerInfos[1 - board.my_turn], _game_name, v);
	}

    private function _handleWho(e:ServerMessageEvent):void{
      var users:Array = e.message.split("\n");
      var user_list:Array = new Array();
	  var waiter_list:Array = new Array();
      for each(var user_data:String in users){
        if(user_data.match("##[WHO] +OK") != null){
          break;
        }
        trace("user_data:" + user_data);
        var match:Array = user_data.match(/\#\#\[WHO\] (.*) x1 (.*)/);
        if(match != null){
          var user:Object = {
			  'name':match[1],
			  'status':StringUtil.trim(match[2].split(" ")[0]),
			  'status2':"",
			  'opponent':"",
			  'game_name':match[2].split(" ")[1],
			  'turn':match[2].split(" ")[2],
			  'rating':parseInt(match[2].split(" ")[3]),
			  'country_code':parseInt(match[2].split(" ")[4]),
			  'titleName':"",
			  'monitor_game':match[2].split(" ")[6],
			  'moves':parseInt(match[2].split(" ")[7]),
			  'wins':parseInt(match[2].split(" ")[8]),
			  'losses':parseInt(match[2].split(" ")[9]), 
			  'streak':parseInt(match[2].split(" ")[10]), 
			  'streak_best':parseInt(match[2].split(" ")[11])
			  }
		  user.country = _infoFetcher.country_names[user.country_code];
		  user.opponent = match[2].split(" ")[5] == "*" ? "" : match[2].split(" ")[5];
		  if (user.monitor_game != "*") user.status2 = "M ";
          if(user.status == "game_waiting" || user.status == "game" || user.status == "post_game"){
            var game_info:Array = user.game_name.match(/^([0-9a-z]+?)_(.*)-([0-9]*)-([0-9]*)/);
            var total:int = parseInt(game_info[3]) / 60;
			var hc:String;
			if (game_info[1] == "r") {
				hc = "R";
			} else if (game_info[1].match(/^hc/)) {
				hc = "HC";
			} else {
				hc = "NR";
			}
            user.rule = hc + ": " + total + "-" + game_info[4];
            if(user.status == "game_waiting"){
              user.status2 += "W";
            } else if (user.status == "post_game") {
				user.status2 = "P " + (user.turn == "+" ? "▲" : "△");
			} else {
              user.status2 = "G " + (user.turn == "+" ? "▲" : "△"); // + user.moves;
            }
          }
          user_list.push(user);
        }
      }

	  for (var j:int = 0; j < _infoFetcher.titleUser.length; j++) {
		  for (var i:int = 0; i < user_list.length; i++) {
			  if (user_list[i].name.toLowerCase() == _infoFetcher.titleUser[j]) {
				  user_list[i].titleName = _infoFetcher.titleName[j];
				  if (_infoFetcher.titleName[j] == "livebot") {
					  user_list[i].rating = 3000;
				  }
				  break;
			  }
		  }
	  }
	  for (i = 0; i < user_list.length; i++) {
		  user_list[i].rank = InfoFetcher.makeRankFromRating(user_list[i].rating);
		  if (user_list[i].status2.match(/W/)) {
			  user = {
				  'name':user_list[i].name,
				  'turn':user_list[i].turn,
				  'rating':user_list[i].rating,
				  'game_name': user_list[i].game_name,
				  'country':_infoFetcher.country_names[user_list[i].country_code],
				  'country3':_infoFetcher.country_names3[user_list[i].country_code]
				  }
		  	  game_info = user.game_name.match(/^([0-9a-z]+?)_(.*)-([0-9]*)-([0-9]*)/);
			  total = parseInt(game_info[3]) / 60;
			  if (game_info[1] == "r") {
				  user.rated = "R"
			  } else {
				  user.rated = "NR"
			  }
			  user.handicap = InfoFetcher.gameTypeShort(game_info[1]);
			  user.time = total + "-" + game_info[4] ;
			  waiter_list.push(user);
			  if (user.name == _login_name && game_info[2] != _login_name) {
				  _challenging = false;
				  _client.stopWaiting();
				  if (_waiting) _client.waitAgain();
			  }
		  }
	  }

      user_list.sortOn("rating", Array.NUMERIC | Array.DESCENDING);
	  _user_list = user_list;
      userListGrid.dataProvider = _user_list;
      for (i = 0; i < user_list.length; i++) {
        if (_user_list[i].name == _login_name) {
          userListGrid.selectedIndex = i;
		  userListGrid.scrollToIndex(i);
          break;
        }
      }
	  userListPanel.title = "Main Lobby (" + _user_list.length + " players)";
	  
	  waiter_list.sortOn("rating", Array.NUMERIC | Array.DESCENDING);
	  _waiter_list = waiter_list;
	  waiterListGrid.dataProvider = _waiter_list;
    }

    private function _writeUserMessage(message:String, n:int, colorCode:String, bold:Boolean = false):void {
		switch (n) {
			case 0:
				break;
			case 1:
				var nowDate:Date = new Date(); 
				_lastChatTime = "Last message receive: " + nowDate.getHours().toString() + ":" + (100 + nowDate.getMinutes()).toString().substr(1);
				_userMessageScrollPos1 = userMessage1.verticalScrollPosition
				userMessage1.htmlText += "<font color='" + colorCode + "'>" + (bold ? "<b>" : "") + message.replace(/</g, "&lt;") + (bold ? "</b>" : "") + "</font>";
				userMessage1.callLater(_scrollDown1);
				break;
			case 2:
				_userMessageScrollPos2 = userMessage2.verticalScrollPosition
				userMessage2.htmlText += "<font color='" + colorCode + "'>" + (bold ? "<b>" : "") + message.replace(/</g, "&lt;") + (bold ? "</b>" : "") + "</font>";
				userMessage2.callLater(_scrollDown2);
				break;		
		}
    }

    private function _scrollDown1():void{
      if (_chat_auto_scroll1) userMessage1.verticalScrollPosition = userMessage1.maxVerticalScrollPosition;
	  else userMessage1.verticalScrollPosition = _userMessageScrollPos1;
    }

	private function _scrollDown2():void{
      if (_chat_auto_scroll2) userMessage2.verticalScrollPosition = userMessage2.maxVerticalScrollPosition;
	  else userMessage2.verticalScrollPosition = _userMessageScrollPos2;
    }
    
    private function _waitForGame(total:int=1500,byoyomi:int=30,handicap:String="r"):void{
      _client.waitForGame(total,byoyomi,handicap);
      _refresh();
      stopButton.enabled = true;
    }
    
    private function _showOptions():void{
      _optionWindow = OptionDialog(PopUpManager.createPopUp(this, OptionDialog, false));
      PopUpManager.centerPopUp(_optionWindow);
      with(_optionWindow){
        title = "Options";
		RadioGroup1.selectedValue = GameTimer.soundType;
        RadioGroup2.selectedValue = board.piece_type;
        pieceSoundCheckBox.selected = board.piece_sound_play;
        gameEndSoundCheckBox.selected = _end_sound_play;
        chatSound1CheckBox.selected = _chat_sound1_play;
        chatSound2CheckBox.selected = _chat_sound2_play;
        OkButton.addEventListener("click", _handleOption);
		saveSettingsButton.addEventListener("click", _handleSaveSettings);
      }
    }
    
    private function _handleOption(e:Event):void {
	  GameTimer.soundType = int(_optionWindow.RadioGroup1.selectedValue);
      board.setPieceType(int(_optionWindow.RadioGroup2.selectedValue));
      board.piece_sound_play = _optionWindow.pieceSoundCheckBox.selected;
      _end_sound_play = _optionWindow.gameEndSoundCheckBox.selected;
      _chat_sound1_play = _optionWindow.chatSound1CheckBox.selected;
      _chat_sound2_play = _optionWindow.chatSound2CheckBox.selected;
    }
	
	private function _handleSaveSettings(e:Event):void {
		var urlVariables:URLVariables = new URLVariables();
		_handleOption(e);
		urlVariables.name = _login_name.toLowerCase();
		urlVariables.pieceSound = board.piece_sound_play;
		urlVariables.endSound = _end_sound_play;
		urlVariables.chatSound1 = _chat_sound1_play;
		urlVariables.chatSound2 = _chat_sound2_play;
		urlVariables.byoyomi = GameTimer.soundType;
		urlVariables.pieceType = board.piece_type;
		_infoFetcher.writeSettings(urlVariables);
	}
	
	private function _handleLoadOption(e:Event):void {
		board.piece_sound_play = _infoFetcher.userSettings.pieceSound;
		_end_sound_play = _infoFetcher.userSettings.endSound;
		_chat_sound1_play = _infoFetcher.userSettings.chatSound1;
		_chat_sound2_play = _infoFetcher.userSettings.chatSound2;
		GameTimer.soundType = _infoFetcher.userSettings.byoyomi;
		board.setPieceType(_infoFetcher.userSettings.pieceType);
	}

    private function _challengeForm():void{
      var user:Object = waiterListGrid.selectedItem;
      if (user != null) {
        var match:Array = user.game_name.match(/^([0-9a-z]+?)_(.*)-([0-9]*)-([0-9]*)/);
        var total:int = parseInt(match[3]) / 60 ;
        var rule:String = total + "min - " + match[4] + "sec";
		var hc:String = InfoFetcher.gameType(match[1]);
        Alert.yesLabel = "Challenge";
        Alert.noLabel = "Offer your setting";
        Alert.buttonWidth = 140;
        Alert.show("Opponent: " + match[2] + "\nTime: " + rule + "\nGame type: " + hc,"Game Setting",Alert.YES|Alert.CANCEL,this,_handleChallengeAlert);
        //set properties back to default.
        Alert.yesLabel = "Yes";
        Alert.noLabel = "No";
        Alert.buttonWidth = 60;
      }    
    }

    private function _handleChallengeAlert(e:CloseEvent):void{
      var user:Object = waiterListGrid.selectedItem;
      if (e.detail == Alert.YES) {
      _challenging = true;
      _writeUserMessage("Challenging..... (Must wait for 20 seconds max)\n", 1, "#008800");
      _client.challenge(user);
    } else if (e.detail == Alert.CANCEL) {
      } else {
        var challengeWindow:ChallengeForm = ChallengeForm(PopUpManager.createPopUp(this, ChallengeForm, true));
        PopUpManager.centerPopUp(challengeWindow);
        challengeWindow.title = "Challenge to " + user.name;
        challengeWindow.challengeButton.addEventListener("click",_challenge);
      }
      challengeButton.enabled = false;
    }

    private function _newGameForm():void{
      _newGameWindow = NewGameForm(PopUpManager.createPopUp(this, NewGameForm, true));
      PopUpManager.centerPopUp(_newGameWindow);
      with(_newGameWindow){
        title = "Create new game";
		nonrated_total.selectedIndex = _ur_total_selected;
		nonrated_byoyomi.selectedIndex = _ur_byoyomi_selected;
		nonrated_handicap.selectedIndex = _ur_handicap_selected;
		addEventListener(GameRuleEvent.RULE_SELECTED,_handleRuleSelected);
      }
    }
  
    private function _stopWaiting():void {
	  _waiting = false;
      _client.stopWaiting();
      _refresh();
      stopButton.enabled = false;
    }

    private function _handleRuleSelected(e:GameRuleEvent):void {
	  _ur_total_selected = _newGameWindow.nonrated_total.selectedIndex;
	  _ur_byoyomi_selected = _newGameWindow.nonrated_byoyomi.selectedIndex;
	  _ur_handicap_selected = _newGameWindow.nonrated_handicap.selectedIndex;
      _waitForGame(e.total, e.byoyomi, e.handicap);
	  _waiting = true;
    }

    private function _challenge(e:Event):void{
      var user:Object = userListGrid.selectedItem;
      if(user != null){
        _client.challenge(user);
      }
	  challengeButton.enabled = false;
    }

    private function _refresh():void {
	  _keepAliveTimer.reset();
	  _keepAliveTimer.start();
      _client.who();
	  _client.list();
	  if (_game_name) _client.watchers(_game_name);
	  challengeButton.enabled = false;
//	  watchButton.enabled = false;
    }

	private function _resignAlert():void {
		if (board.my_turn == board.position.turn)
        Alert.show("","Resign?",Alert.YES|Alert.NO,this,_resign);
	}
	
    private function _resign(e:CloseEvent):void {
		if (e.detail == Alert.YES) _client.resign();
    }

    private function _who():void{
      _client.who();
    }

    private function _closeGame():void {
	  if (_game_name) {
		  if (_monitoring) {
			  _client.monitorOff(_game_name);
			  _monitoring = false;
		  } else if (board.viewing) {
		  } else {
			  _client.closeGame();
			  _sendAutoChat("I have left this room.");
		  }
          _game_name = null;
	  }
      board.closeGame();
	  if (board.viewing) {
		  mainViewStack.selectedIndex = 3;
		  chatMessage2.enabled = true;
		  board.viewing = false;
	  } else {
		  mainViewStack.selectedIndex = 1;
	  }
      challengeButton.enabled = false;
	  logoutButton.enabled = true;
	  rewindAllButton.setStyle('color', 'undefined');
	  rewindAllButton.setStyle('textRollOverColor', 'undefined');
	  rewindOneButton.setStyle('color', 'undefined');
	  rewindOneButton.setStyle('textRollOverColor', 'undefined');
	  forwardOneButton.setStyle('color', 'undefined');
	  forwardOneButton.setStyle('textRollOverColor', 'undefined');
	  forwardAllButton.setStyle('color', 'undefined');
	  forwardAllButton.setStyle('textRollOverColor', 'undefined');
      _refresh();
    }
    
    private function _showImpasse():void {
      Alert.show("Black: " + board.position.calcImpasse(Kyokumen.SENTE) + " points\nWhite: " + board.position.calcImpasse(Kyokumen.GOTE) + " points", "Points for Impasse", Alert.OK);
    }

    private function _userSelected():void {
      var user:Object = userListGrid.selectedItem;
	  for (var i:int = 0; i < _game_list.length; i++) {
		  if (_game_list[i].blackName == user.name || _game_list[i].whiteName == user.name) {
			  gameListGrid.selectedIndex = i;
			  break;
		  }
		  if (user.monitor_game != "*" && user.monitor_game.split("+")[0] == _game_list[i].blackName && user.monitor_game.split("+")[1] == _game_list[i].whiteName) {
			  gameListGrid.selectedIndex = i;
			  break;
		  }
		  gameListGrid.selectedIndex = -1;
	  }
	  if (_game_name) return;
	  for (i = 0; i < _waiter_list.length; i++) {
		  if (_waiter_list[i].name == user.name) {
			  waiterListGrid.selectedIndex = i;
				  if(_waiter_list[i].name != _login_name && _waiter_list[i].game_name.indexOf(_waiter_list[i].name) >= 0){
					challengeButton.enabled = true;
				  } else {
					challengeButton.enabled = false;
				  }
			  break;
		  }
		  waiterListGrid.selectedIndex = -1;
		  challengeButton.enabled = false;
	  }
//	  _waiterSelected();
//	  _gameSelected();
    }
	
    private function _waiterSelected():void {
	  if (_game_name) return;
      var user:Object = waiterListGrid.selectedItem;
	  if (!user) {
		  challengeButton.enabled = false;
		  return;
	  }
      if(user != null && user.name != _login_name && user.game_name.indexOf(user.name) >= 0){
        challengeButton.enabled = true;
      } else {
		challengeButton.enabled = false;
	  }
	  for (var i:int = 0; i < _user_list.length; i++) {
		  if (_user_list[i].name == user.name) {
			  userListGrid.selectedIndex = i;
			  break;
		  }
		  userListGrid.selectedIndex = -1;
	  }
	  gameListGrid.selectedIndex = -1;
    }
	
    private function _gameSelected():void {
//	  if (_game_name) return;
      var game:Object = gameListGrid.selectedItem;
//	  if (!game) {
//		  watchButton.enabled = false;
//		  return;
//	  }
//      if(game != null){
//        watchButton.enabled = true;
//      } else {
//		watchButton.enabled = false;
//	  }
//	  if (userListGrid.selectedItem.name == game.blackName || userListGrid.selectedItem.name == game.whiteName) return;
	  for (var i:int = 0; i < _user_list.length; i++) {
		  if (_user_list[i].name == game.blackName || _user_list[i].name == game.whiteName) {
			  userListGrid.selectedIndex = i;
			  break;
		  }
		  userListGrid.selectedIndex = -1;
	  }
	  waiterListGrid.selectedIndex = -1;
	  challengeButton.enabled = false;
    }

    private function _playerMove(from:Point, to:Point, promote:Boolean):void {
	  var str:String = board.position.generateMovementFromCoordinates(from, to, promote).toCSA();
	  if (board.post_game && board.isWinner) {
		  rewindAllButton.setStyle('color', '0xFF0000');
		  rewindAllButton.setStyle('textRollOverColor', '0xFF0000');
		  rewindOneButton.setStyle('color', '0xFF0000');
		  rewindOneButton.setStyle('textRollOverColor', '0xFF0000');
		  forwardOneButton.setStyle('color', '0xFF0000');
		  forwardOneButton.setStyle('textRollOverColor', '0xFF0000');
		  forwardAllButton.setStyle('color', '0xFF0000');
		  forwardAllButton.setStyle('textRollOverColor', '0xFF0000');
		  board.study_list.push(str);
		  if (board.study_list_hold.length == 0) _sendAutoChat("Launched study mode at #" + board.studyOrigin);
		  board.study_list_hold = board.study_list;
		  _sendStudy();
	  } else if (board.post_game && board.isLoser) {
		  board.study_list.push(str);
		  _sendStudy();
	  } else {
		  _client.move(str);
	  }
    }
	
	private function _sendStudy():void {
		var str:String = "[##STUDY]" + board.studyOrigin;
		if (board.study_list.length > 0){
			for (var i:int = 0; i < board.study_list.length; i ++) str += "/" + board.study_list[i];
		} else {
			str += "/*";
		}
		_client.gameChat(_game_name, str);
	}

    private function _checkTimeout():void {
	  board.clientTimeout();
      _client.checkTimeout();
    }

    private function _handleList(e:ServerMessageEvent):void{
	  var game_list:Array = new Array();
	  var lines:Array = e.message.split("\n");
        for each(var line:String in lines) {
		  if (line.match(/^##\[LIST\] \+OK$/)) break;
          var tokens:Array = line.split(" ");
          var game:Object = {
			  'id':tokens[1], //line.substr(9),
			  'blackName':tokens[1].split("+")[2],
			  'whiteName':tokens[1].split("+")[3],
			  'blackRating':parseInt(tokens[3]),
			  'whiteRating':parseInt(tokens[4]),
			  'blackCountryCode':parseInt(tokens[5]),
			  'whiteCountryCode':parseInt(tokens[6]),
			  'watchers':parseInt(tokens[10]),
			  'blackTitle':"",
			  'whiteTitle':""
			  }
		  var user:Object;
		  if ((user = _findPlayerFromList(game.blackName))) {
			  game.blackWins = user.wins;
			  game.blackLosses = user.losses;
			  game.blackStreakBest = user.streak_best;
		  }
		  if ((user = _findPlayerFromList(game.whiteName))) {
			  game.whiteWins = user.wins;
			  game.whiteLosses = user.losses;
			  game.whiteStreakBest = user.streak_best;
		  }
		  game.blackCountry = _infoFetcher.country_names[game.blackCountryCode];
		  game.blackFlagURL = "http://www.81squareuniverse.com/dojo/images/flags_s/" + String(game.blackCountryCode + 1000).substring(1) + ".gif";
		  game.whiteCountry = _infoFetcher.country_names[game.whiteCountryCode];
		  game.whiteFlagURL = "http://www.81squareuniverse.com/dojo/images/flags_s/" + String(game.whiteCountryCode + 1000).substring(1) + ".gif";
		  if (tokens[7] == "true") {
			  game.status = "G: " + parseInt(tokens[2]);
		  } else {
			  game.status = "P";
			  if (tokens[8] == "true") game.status += "▲";
			  if (tokens[9] == "true") game.status += "△";
		  }
		  for (var i:int = 0; i < _infoFetcher.titleName.length; i++) {
				if (game.blackName.toLowerCase() == _infoFetcher.titleUser[i]) {
					game.blackTitle = _infoFetcher.titleName[i];
					if (game.blackTitle == "livebot") game.blackRating = 3000;
				}
				if (game.whiteName.toLowerCase() == _infoFetcher.titleUser[i]) {
					game.whiteTitle = _infoFetcher.titleName[i];
					if (game.whiteTitle == "livebot") game.whiteRating = 3000;
				}
		  }
		  game.maxRating = Math.max(game.blackRating, game.whiteRating);
		  if (game.status == "P" || game.status == "P▲" || game.status == "P△") game.maxRating -= 3000;
		  game.blackRank = InfoFetcher.makeRankFromRating(game.blackRating);
		  game.whiteRank = InfoFetcher.makeRankFromRating(game.whiteRating);
		  var game_info:Array = game.id.split("+")[1].match(/^([0-9a-z]+)_(.*)-([0-9]*)-([0-9]*)/);
		  var total:int = parseInt(game_info[3]) / 60;
		  var hc:String;
		  if (game_info[1] == "r") {
			hc = "R";
			game.hcTip = "";
		  } else if (game_info[1].match(/^hc/)) {
			hc = "HC";
			game.hcTip = InfoFetcher.gameTypeShort(game_info[1]);
		  } else {
			hc = "NR";
			game.hcTip = "";
		  }
		  game.rule = hc + ": " + ((total < 10) ? " " : "") + total + "-" + game_info[4];
		  game_list.push(game);
        }
		game_list.sortOn("maxRating", Array.NUMERIC | Array.DESCENDING);
		for (i = 0; i < game_list.length; i++) game_list[i].gameNo = i + 1;
		_game_list = game_list;
		gameListGrid.dataProvider = _game_list;
    }

    private function _handleMonitor(e:ServerMessageEvent):void {
      var kifuMove:Object = new Object();
	  var end_game:Boolean = false;
      if(e.message.indexOf("#TIME_UP") >= 0){
		end_game = true;
        board.timeout();
        _writeUserMessage((board.last_pos.turn == Kyokumen.SENTE ? "Black: " : "White: ") + "Time up.\n", 2, "#DD0088");
		kifuMove.num = board.kifu_list.length;
        kifuMove.move = (board.last_pos.turn == Kyokumen.SENTE ? "▲" : "△") + "Time up";
        kifuMove.moveKIF = "切れ負け";
        board.kifu_list.push(kifuMove);
	  } else if (e.message.indexOf("#DISCONNECT") >= 0) {
		  end_game = true;
		  _writeUserMessage("Player disconnected.\n", 2, "#DD0088");
      } else if(e.message.indexOf("#ILLEGAL_MOVE") >= 0){
		end_game = true;  
        _writeUserMessage("Illegal Move.\n", 2, "#DD0088");
		kifuMove.num = board.kifu_list.length;
		kifuMove.move = "Illegal Move";
		kifuMove.moveKIF = "相手の反則にて勝ち";
		board.kifu_list.push(kifuMove);
      } else if (e.message.indexOf("#RESIGN") >= 0) {
		  end_game = true;
		  _writeUserMessage((board.last_pos.turn == Kyokumen.SENTE ? "Black" : "White")  + " resigned.\n", 2, "#DD0088");
	  } else if (e.message.indexOf("#OUTE_SENNICHITE") >= 0) {
		  end_game = true;
          _writeUserMessage("Illegal Perpetual Check.\n", 2, "#DD0088");
		  kifuMove.num = board.kifu_list.length;
		  kifuMove.move = "Perpetual Check";
		  kifuMove.moveKIF = "王手千日手";
		  board.kifu_list.push(kifuMove);		  
      } else if (e.message.indexOf("#SENNICHITE") >= 0) {
		  end_game = true;
          _writeUserMessage("Sennichite. (Repetition)\n", 2, "#DD0088");
		  kifuMove.num = board.kifu_list.length;
		  kifuMove.move = "Repetition Draw";
		  kifuMove.moveKIF = "千日手";
		  board.kifu_list.push(kifuMove);
      }
	  if (end_game) {
			board.post_game = true;
			radioKifuReplay.enabled = true;
			radioKifuListen.enabled = true;
			radioKifuReplay.selected = true;
			board.onListen = false;
			_writeUserMessage("### Game End ###\n", 2, "#DD0088", true);
			if (_end_sound_play) _sound_win.play();
			kifuCopyButton.enabled = true;
			kifuSaveButton.enabled = true;
			board.endGame();
	  } else {
		  if(_watch_game != null) board.monitor(e.message,_watch_game);
	  }
	  var i:int = kifuDataGrid.selectedIndex;
	  kifuDataGrid.scrollToIndex(0);
	  kifuDataGrid.dataProvider = board.kifu_list;
	  kifuDataGrid.selectedIndex = board.onListen ? (board.kifu_list.length - 1) : i;
	  kifuDataGrid.callLater(_scrollDownKifu);
    }
	
	private function _scrollDownKifu():void {
		kifuDataGrid.scrollToIndex(kifuDataGrid.selectedIndex);
	}
	
	private function _watchDialog():void {
		if (_game_name) return;
		Alert.yesLabel = "Black";
        Alert.noLabel = "White";
		Alert.buttonWidth = 80;
        Alert.show("View as:","Choose Side",Alert.YES|Alert.NO,this,_watch);
        //set properties back to default.
        Alert.yesLabel = "Yes";
        Alert.noLabel = "No";
        Alert.buttonWidth = 60;
	}

    private function _watch(e:CloseEvent):void {
      _watch_game = gameListGrid.selectedItem;
      if (_watch_game != null) {
		 if (e.detail == Alert.YES) {
			board.my_turn = Kyokumen.SENTE;
		 } else {
			 board.my_turn = Kyokumen.GOTE;
		 }
		 _game_name = _watch_game.id;
		 if (_watch_game.rule.match(/^HC/)) {
			 board.superior = Kyokumen.GOTE;
		 } else if (_watch_game.blackRating > _watch_game.whiteRating) {
			 board.superior = Kyokumen.SENTE;
		 } else {
			 board.superior = Kyokumen.GOTE;
		 }
		_monitoring = true;
		board.post_game = false;
		board.isWinner = false;
		board.isLoser = false;
		_client.monitorOn(_game_name);
		_client.watchers(_game_name);
		
//		  watchButton.enabled = false;
		  logoutButton.enabled = false;
		  userMessage2.htmlText = "";
		  _writeUserMessage(_infoFetcher.gameMessage + "\n\n", 2, "#008800");
		  mainViewStack.selectedIndex = 2;
		  closeButton.enabled = true;
		  resignButton.enabled = false;
		  rewindAllButton.enabled = true;
		  rewindOneButton.enabled = true;
		  forwardOneButton.enabled = true;
		  forwardAllButton.enabled = true;
		  kifuDataGrid.selectable = true;
		  kifuDataGrid.dataProvider = board.kifu_list;
		  radioKifuListen.selected = true;
		  radioKifuReplay.enabled = true;
		  radioKifuListen.enabled = true;
		  board.onListen = true;
	  }
    }
	
	private function _findPlayerFromList(str:String):Object {
		for (var i:int = 0; i < _user_list.length; i++) {
			if (_user_list[i].name == str) return _user_list[i];
		}
		return null;
	}
	
	private function _openPlayerInfo(user:Object):void {
	  if (!user) return;
	  _playerInfoWindow = PlayerInfoWindow(PopUpManager.createPopUp(this, PlayerInfoWindow, false));
      PopUpManager.centerPopUp(_playerInfoWindow);
      _playerInfoWindow.title = "Player Info";
	  _playerInfoWindow.readUser(user);
	  _playerInfoWindow.directMessage.addEventListener(FlexEvent.ENTER, _handleSendPrivateChat);
	  if (_isPlayer()) {
		  _playerInfoWindow.directMessage.enabled = false;
	  } else {
		  _playerInfoWindow.directMessage.enabled = true;
		  _playerInfoWindow.directMessage.setFocus();
	  }
	}
	
	private function _playerInfoFromText(textArea:TextArea):void {
		var selectedText:String = textArea.text.substring(textArea.selectionBeginIndex, textArea.selectionEndIndex);
		var match:Array;
		if ((match = selectedText.match(/^\[(.+)\]$/))) _openPlayerInfo(_findPlayerFromList(match[1]));
	}
	
	private function _gamePlayerInfo(e:MouseEvent):void {
	  _openPlayerInfo(_findPlayerFromList(e.target.text));
	}

    private function _handleSendChat1(e:FlexEvent):void {
	  var match:Array;
	  if ((match = e.target.text.match(/^@(.+?)\s(.+)$/))) {
		  _sendPrivateChat(match[1], match[2]);
	  } else {
		_client.chat(e.target.text);
	  }
      e.target.text = "";
    }
	
    private function _handleSendChat2(e:FlexEvent):void {
	  var match:Array;
	  if ((match = e.target.text.match(/^@(.+?)\s(.+)$/))) {
		  _sendPrivateChat(match[1], match[2]);
	  } else {
		if (_game_name) _client.gameChat(_game_name, e.target.text);
	  }
      e.target.text = "";
    }
	
	private function _handleSendPrivateChat(e:FlexEvent):void {
		_sendPrivateChat(e.target.parent.parent.nameLabel.text, e.target.text);
		e.target.text = "";
	}
	
	private function _sendPrivateChat(sendTo:String, message:String):void {
		if (!_isPlayer()) {
			var user:Object = _findPlayerFromList(sendTo);
			if (!user) {
				Alert.show("User not found online");
				return;
			} else if (user.status == "game") {
				if  (_game_name && _monitoring && sendTo == board.playerInfos[0].name) {
					_client.privateChat(sendTo, message);
					_client.privateChat(board.playerInfos[1].name, "[auto-PM] Sent private message to Black.");
					_client.gameChat(_game_name, "[auto-chat&PM] Sent private message to Black.");
				} else if (_game_name && _monitoring && sendTo == board.playerInfos[1].name) {
					_client.privateChat(sendTo, message);
					_client.privateChat(board.playerInfos[0].name, "[auto-chat] Sent private message to White.");
					_client.gameChat(_game_name, "[auto-chat&PM] Sent private message to White.");
				} else {
					Alert.show("User is now playing.");
					return;
				}
			} else {
				_client.privateChat(sendTo, message);
				if (mainViewStack.selectedIndex == 1) {
					_writeUserMessage("PM To " + sendTo + ": " + message + "\n", 1, "#0033DD");
					if (_chat_sound1_play) _sound_chat1.play();
				} else {
					_writeUserMessage("PM To " + sendTo + ": " + message + "\n", 2, "#0033DD");
					if (_chat_sound2_play) _sound_chat2.play();
				}
			}
		}
	}
  
  private function _sendAutoChat(str:String):void {
    if (_game_name) {
      _client.gameChat(_game_name, "[auto-chat] " + str);
    } else {
	  _client.chat("[auto-chat] " + str);
	}
  }
  
  private function _isPlayer():Boolean {
	  if (_game_name && !board.post_game) {
		  if (board.playerInfos[0].name == _login_name || board.playerInfos[1].name == _login_name) return true;
	  }
	  return false;
  }
 
  private function _mute(v:Boolean):void {
	  var trans:SoundTransform = new SoundTransform;
	  if (v) {
		  trans.volume = 0;
	  } else {
		  trans.volume = 1;
	  }
	  SoundMixer.soundTransform = trans;
	  muteCheck1.selected = v;
	  muteCheck2.selected = v;
  }
  
  private function _change_auto_scroll1():void {
	  _chat_auto_scroll1 = autoScrollCheck1.selected;
  }
   
  private function _change_auto_scroll2():void {
	  _chat_auto_scroll2 = autoScrollCheck2.selected;
  }
  
  private function _checkLobby():void {
	  mainViewStack.selectedIndex = 1;
	  backToGameButton.visible = true;
	  searchViewButton.enabled = false;
  }

  private function _backToGame():void {
	  mainViewStack.selectedIndex = 2;
	  backToGameButton.visible = false;
	  searchViewButton.enabled = true;
  }
  
  private function _killGhost(str:String):void {
	  _client.send("%%GHOST " + str);
  }
  
  private function _toggleListen():void {
	  if (radioKifuListen.selected) {
		  board.onListen = true;
		  if (board.post_game && !board.isWinner) {
			  kifuDataGrid.selectedIndex = board.studyOrigin;
			  board.replayMoves(board.studyOrigin);
			  if (board.study_list.length > 0){
				for (var i:int = 0; i < board.study_list.length; i++) board.makeMove(board.study_list[i] + ",T0", false);
			  }
		  }
		  if (_monitoring && !board.post_game) {
			  kifuDataGrid.selectedIndex = board.kifu_list.length - 1;
			  board.replayMoves(board.kifu_list.length - 1);
		  }
	  } else {
		  board.onListen = false;
		  if (board.post_game && !board.isWinner) {
			board.replayMoves(kifuDataGrid.selectedIndex);
		  }
	  }
  }
  
  private function _saveKIF():void {
	  var date_time:String = _game_name.split("+")[4];
	  var fileReference:FileReference = new FileReference();
	  //fileReference.save(Jcode.getInstance().UTF8toSJIS(_formatKIF()), "81Dojo-" + date_time.substr(0,4) + "-" + date_time.substr(4,2) + "-" + date_time.substr(6,2) + "-" + date_time.substr(8,2) + "-" + date_time.substr(10,2)  + ".kif");
  }
 
	private function _formatKIF():String{
		  var KIFDataText:String = "";
		  KIFDataText += "開始日時：" + _game_name.split("+")[4].substr(0,4) + "/" + _game_name.split("+")[4].substr(4,2) + "/" + _game_name.split("+")[4].substr(6,2) + "\n";
		  KIFDataText += "場所：81-Dojo (" + VERSION +")\n";
		  KIFDataText += InfoFetcher.gameTypeKIF(_game_name.split("+")[1].match(/^([0-9a-z]+?)_/)[1]);
		  KIFDataText += "先手：" + board.playerInfos[0].name + "\n";
		  KIFDataText += "後手：" + board.playerInfos[1].name + "\n";
		  KIFDataText += "手数----指手---------消費時間--\n";
		  for (var i:int = 1; i < board.kifu_list.length ; i++){
			KIFDataText += "   " + String(i) + " ";
			KIFDataText += board.kifu_list[i].moveKIF + "\n";
		  }
		  return KIFDataText;
	}
	
	private function _sendKifuSearch():void {
		if (kifuSearchPlayerText.text && kifuSearchFromChooser.selectedDate && kifuSearchToChooser.selectedDate) {
			_api.kifuSearch(kifuSearchPlayerText.text, kifuSearchFromChooser.selectedDate, kifuSearchToChooser.selectedDate);
		}
	}
	
	private function _handleKifuSearch(e:Event):void {
		_kifu_search_list = new Array();
		var hc:String;
		var match:Array;
		for each (var kifu:Object in e.target.bufferData) {
			match = kifu.game_id.split("+")[1].match(/^([0-9a-z]+?)_.+\-(\d+)\-(\d+)$/);
			if (match[1] == "r") {
				hc = "R";
			} else if (match[1] == "nr") {
				hc = "NR";
			} else {
				hc = "HC";
			}
			kifu.rule = hc + ": " + parseInt(match[2])/60 + "-" + parseInt(match[3])
			kifu.black = kifu.game_id.split("+")[2];
			kifu.white = kifu.game_id.split("+")[3];
			kifu.date = kifu.game_id.split("+")[4].substr(0, 4) + "-" + kifu.game_id.split("+")[4].substr(4, 2) + "-" + kifu.game_id.split("+")[4].substr(6, 2);
			if (kifu.result.split(":")[2].match(/win$/)) {
				kifu.winner = "▲";
			} else if (kifu.result.split(":")[3].match(/win$/)) {
				kifu.winner = "△";
			} else {
				kifu.winner = "DRAW";
			}
			_kifu_search_list.push(kifu);
		}
		kifuSearchGrid.dataProvider = _kifu_search_list;
	}
	
	private function _kifuSearchSelected():void {
		if (kifuSearchGrid.selectedItem) {
			_api.kifuDetail(kifuSearchGrid.selectedItem.id);
		}
	}
	
	private function _handleKifuDetail(e:Event):void {
		board.viewing = true;
		_game_name = e.target.kifuContents.split("\n")[4].substring(7);
		board.startView(e.target.kifuContents);
		resignButton.enabled = false;
		closeButton.enabled = true;
		kifuDataGrid.selectable = true;
		rewindAllButton.enabled = true;
		rewindOneButton.enabled = true;
		forwardAllButton.enabled = true;
		forwardOneButton.enabled = true;
		radioKifuReplay.enabled = true;
		radioKifuReplay.selected = true;
		radioKifuListen.enabled = false;
		kifuCopyButton.enabled = true;
		kifuSaveButton.enabled = true;
		chatMessage2.enabled = false;
		mainViewStack.selectedIndex = 2;
		kifuDataGrid.dataProvider = board.kifu_list;
		kifuDataGrid.selectedIndex = 0;
		board.replayMoves(0);
	}
	
	private function _sendPlayerSearch():void {
		if (playerSearchNameText.text) {
			_api.playerSearch(playerSearchNameText.text.toLowerCase());
		}
	}
	
	private function _handlePlayerSearch(e:Event):void {
		_player_search_list = new Array();
		for each (var player:Object in e.target.bufferData) {
			player.country = _infoFetcher.country_names[player.country_id];
			player.total = parseInt(player.wins) + parseInt(player.losses);
			player.percentage = (100 * player.wins / Math.max(1, player.total)).toFixed(1);
			player.flagURL = "http://www.81squareuniverse.com/dojo/images/flags_s/" + String(player.country_id + 1000).substring(1) + ".gif";
			player.rank = InfoFetcher.makeRankFromRating(player.rate);
			for (var i:int = 0; i < _infoFetcher.titleUser.length; i++) {
				  if (player.login == _infoFetcher.titleUser[i]) {
					  player.title = _infoFetcher.titleName[i];
					  break;
				  }
			}
			_player_search_list.push(player);
		}
		playerSearchGrid.dataProvider = _player_search_list;
	}
	
	private function _sendRankingSearch():void {
		_api.rankingSearch(rankingTabNavigator.selectedIndex);
	}
	
	private function _handleRankingSearch(e:Event):void {
		switch (String(e.target.bufferXML.@item)) {
			case "wins":
				trace("hit");
				_ranking_wins_list = new Array(); break;
			case "rate":
				_ranking_rate_list = new Array(); break;
			case "total":
				_ranking_total_list = new Array(); break;
			case "streak":
				_ranking_streak_list = new Array(); break;
			case "percentage":
				_ranking_percentage_list = new Array(); break;
		}
		var num:int = 0;
		for each (var playerXML:XML in e.target.bufferXML.player) {
			num += 1;
			var player:Object = {
				'number':num,
				'login':String(playerXML.login),
				'country':_infoFetcher.country_names[parseInt(playerXML.country_id)],
				'flagURL':"http://www.81squareuniverse.com/dojo/images/flags_s/" + String(parseInt(playerXML.country_id) + 1000).substring(1) + ".gif",
				'wins':parseInt(playerXML.wins),
				'losses':parseInt(playerXML.losses),
				'total':parseInt(playerXML.wins) + parseInt(playerXML.losses),
				'percentage':(100 * parseInt(playerXML.wins) / Math.max(1, parseInt(playerXML.wins) + parseInt(playerXML.losses))).toFixed(1),
				'streak_best':parseInt(playerXML.streak_best),
				'rate':parseInt(playerXML.rate),
				'rank':InfoFetcher.makeRankFromRating(parseInt(playerXML.rate))
			}
			for (var i:int = 0; i < _infoFetcher.titleUser.length; i++) {
				  if (player.login == _infoFetcher.titleUser[i]) {
					  player.title = _infoFetcher.titleName[i];
					  break;
				  }
			}
			switch (String(e.target.bufferXML.@item)) {
				case "wins":
					_ranking_wins_list.push(player); break;
				case "rate":
					_ranking_rate_list.push(player); break;
				case "total":
					_ranking_total_list.push(player); break;
				case "streak":
					_ranking_streak_list.push(player); break;
				case "percentage":
					_ranking_percentage_list.push(player); break;
			}
		}
		winRankingGrid.dataProvider = _ranking_wins_list;
		totalRankingGrid.dataProvider = _ranking_total_list;
		streakRankingGrid.dataProvider = _ranking_streak_list;
		percentageRankingGrid.dataProvider = _ranking_percentage_list;
		rateRankingGrid.dataProvider = _ranking_rate_list;
	}

  private function kifuListSelected():void {
	if (board.post_game && board.isWinner) {
		board.studyOrigin = kifuDataGrid.selectedIndex;
		if (board.study_list_hold.length > 0) {
			_sendAutoChat("Quit study mode.");
			board.study_list = new Array();
			board.study_list_hold = new Array();
			rewindAllButton.setStyle('color', 'undefined');
			rewindAllButton.setStyle('textRollOverColor', 'undefined');
			rewindOneButton.setStyle('color', 'undefined');
			rewindOneButton.setStyle('textRollOverColor', 'undefined');
			forwardOneButton.setStyle('color', 'undefined');
			forwardOneButton.setStyle('textRollOverColor', 'undefined');
			forwardAllButton.setStyle('color', 'undefined');
			forwardAllButton.setStyle('textRollOverColor', 'undefined');
		}
		_sendStudy();
	}
	radioKifuReplay.selected = true;
	board.onListen = false;
    board.replayMoves(kifuDataGrid.selectedIndex);
  }
    
  private function replayByButton(i:int):void {
	radioKifuReplay.selected = true;
	board.onListen = false;
    switch (i) {
      case -2:
	    if (board.post_game && board.isWinner && board.study_list_hold.length > 0) {
			if (board.study_list.length == 0) {
				board.study_list_hold = new Array();
				_sendAutoChat("Quit study mode.");
				kifuDataGrid.selectedIndex = 0;
			} else {
				board.study_list = new Array();
			}
		} else {
			kifuDataGrid.selectedIndex = 0;
		}
        break;
      case -1:
	    if (board.post_game && board.isWinner && board.study_list_hold.length > 0) {
			if (board.study_list.length == 0) {
				board.study_list_hold = new Array();
				_sendAutoChat("Quit study mode.");
				if (kifuDataGrid.selectedIndex > 0) kifuDataGrid.selectedIndex--;
			} else {
				board.study_list.pop();
			}
		} else if (kifuDataGrid.selectedIndex > 0) {
			kifuDataGrid.selectedIndex--;
        }
        break;
      case 1:
	    if (board.post_game && board.isWinner && board.study_list_hold.length > 0) {
			if (board.study_list_hold.length > board.study_list.length) board.study_list.push(board.study_list_hold[board.study_list.length]);
		} else if (kifuDataGrid.selectedIndex < board.kifu_list.length) {
//		  if (board.post_game && board.isWinner) board.study_list = new Array();
          kifuDataGrid.selectedIndex++;
        }
        break;
      case 2:
	    if (board.post_game && board.isWinner && board.study_list_hold.length > 0) {
			board.study_list = board.study_list_hold;
		} else {
//	    if (board.post_game && board.isWinner) board.study_list = new Array();
			kifuDataGrid.selectedIndex = board.kifu_list.length;
		}
    }
	if (board.post_game && board.isWinner) {
		if (board.study_list_hold.length == 0) {
//			board.replayMoves(kifuDataGrid.selectedIndex);
//			kifuDataGrid.scrollToIndex(kifuDataGrid.selectedIndex);
			rewindAllButton.setStyle('color', 'undefined');
			rewindAllButton.setStyle('textRollOverColor', 'undefined');
			rewindOneButton.setStyle('color', 'undefined');
			rewindOneButton.setStyle('textRollOverColor', 'undefined');
			forwardOneButton.setStyle('color', 'undefined');
			forwardOneButton.setStyle('textRollOverColor', 'undefined');
			forwardAllButton.setStyle('color', 'undefined');
			forwardAllButton.setStyle('textRollOverColor', 'undefined');
		}
		board.studyOrigin = kifuDataGrid.selectedIndex;
		_sendStudy();
	} else {
		board.replayMoves(kifuDataGrid.selectedIndex);
		kifuDataGrid.scrollToIndex(kifuDataGrid.selectedIndex);
	}
  }

    ]]>
  </mx:Script>
  <mx:Fade id="hideLogin" alphaFrom="1.0" alphaTo="0.0" duration="1000" />
  <mx:ViewStack id="mainViewStack" creationPolicy="all" width="100%" height="100%">
    <mx:VBox id="loginBox" horizontalAlign="center" verticalAlign="middle" width="100%" height="100%" fontSize="11" hideEffect="{hideLogin}">
    <mx:Image id="titleBanner" source="http://www.81squareuniverse.com/dojo/images/81Dojo.jpg"/>
	  <mx:Label paddingTop="-2" paddingBottom="0" text="{VERSION}"/>
      <mx:Label paddingTop="-3" text="(powered by ShogiServer and 81SquareUniverse.com)"/>
      <mx:Form>
        <mx:FormItem label="loginname">
            <mx:TextInput id="loginname" width="200"/>
        </mx:FormItem>
        <mx:FormItem label="password">
            <mx:TextInput id="password" width="200" displayAsPassword="true"/>
        </mx:FormItem>
        <mx:FormItem>
            <mx:Button id="loginButton" label="Login" y="400" click="_connectAndLogin();"/>
        </mx:FormItem>
      </mx:Form>
      <mx:Label paddingTop="-2" paddingBottom="0"  id="loginMessage" fontSize="10" />
      <mx:Label paddingTop="-2" paddingBottom="0"  id="errorMessage" color="#ff6666" fontSize="10" />
      <mx:LinkButton paddingTop="-2" label="Sign Up" fontSize="15" click="navigateToURL(new URLRequest('http://81dojo.dyndns.org:2195'), 'quote')" />
      <mx:Label paddingTop="15" text="Chief Programmer: Kota" fontSize="13" />
	  <mx:HBox>
		  <mx:Label text=" " doubleClickEnabled="true" doubleClick="_localLogin();"/>
		  <mx:Label text=" " doubleClickEnabled="true" doubleClick="_testLogin(1);"/>
		  <mx:Label text="Assistant: Hidetchi"/>
		  <mx:Label text=" " doubleClickEnabled="true" doubleClick="_testLogin(2);"/>
		  <mx:Label text=" " doubleClickEnabled="true" doubleClick="_testLogin(3);"/>
	  </mx:HBox>
	  <mx:Label paddingTop="10"  paddingBottom="0" text="- Materials -" fontSize="10" />
	  <mx:LinkButton paddingTop="-2" paddingBottom="0" label="CC Resources for Shogi Applications by muchonovski" click="navigateToURL(new URLRequest('http://www.muchonov.com/bona/'), 'quote')"/>
      <mx:LinkButton paddingTop="-2" paddingBottom="0"  label="www.otosozai.com - ONGAKUSITU" click="navigateToURL(new URLRequest('http://www.otosozai.com/'), 'quote')"/>
	  <mx:LinkButton paddingTop="-2" paddingBottom="0"  label="National flag and Road sign Mt." click="navigateToURL(new URLRequest('http://nflagrsign.xrea.jp/'), 'quote')"/>
    </mx:VBox>
    
    <mx:VBox paddingTop="10" paddingLeft="10" fontSize="11">
      <mx:Panel id="userListPanel" width="975" height="560" paddingLeft="10" paddingTop="10" status="{VERSION}  {_lastChatTime}">
      <mx:HBox>
        <mx:Button id="refreshButton" label="Refresh" click="_refresh();"/>
        <mx:Button id="startButton" label="Wait for Game" click="_newGameForm();"/>
        <mx:Button id="stopButton" label="Stop Waiting" click="_stopWaiting()" enabled="false" />
        <mx:Button id="challengeButton" label="Challenge" click="_challengeForm();" enabled="false"/>
		<mx:Button id="logoutButton" label="Log Out" click="_logout()"/>
		<mx:Button id="optionButton1" label="Options" click="_showOptions();" enabled="true"/>
		<mx:Button id="searchViewButton" label="Search" click="mainViewStack.selectedIndex=3;" />
		<mx:CheckBox id="muteCheck1" label="Mute" click="_mute(muteCheck1.selected)"/>
		<mx:Button id="backToGameButton" label="Back to Game" click="_backToGame();" visible="false" color="#FF0000" />
      </mx:HBox>
	  <mx:HBox>
		<mx:VDividedBox>
			<mx:DataGrid id="userListGrid" width="360" height="360" change="_userSelected();" rowHeight="21" doubleClickEnabled="true" doubleClick="_openPlayerInfo(userListGrid.selectedItem);">
			 <mx:columns>
			  <mx:DataGridColumn dataField="status2" headerText="Stat" width="33" paddingLeft="0" textAlign="center" />
			  <mx:DataGridColumn dataField="titleName" headerText="Title" width="58" paddingLeft="0" textAlign="center" />
			  <mx:DataGridColumn dataField="rank" headerText="Rank" width="52" paddingLeft="0" textAlign="center" />
			  <mx:DataGridColumn dataField="name" headerText="Name" width="100" paddingLeft="2" />
			  <mx:DataGridColumn dataField="country" headerText="Country" width="90" paddingLeft="2" />
			  <mx:DataGridColumn dataField="rating" headerText="Rate" width="45" paddingRight="3" textAlign="right" />
			 </mx:columns>
			</mx:DataGrid>
			<mx:DataGrid id="waiterListGrid" width="360" height="105" change="_waiterSelected();" rowHeight="21" doubleClickEnabled="true" doubleClick="_openPlayerInfo(_findPlayerFromList(waiterListGrid.selectedItem.name));">
			 <mx:columns>
			  <mx:DataGridColumn dataField="name" headerText="Waiting Player" width="90" paddingLeft="2" />
			  <mx:DataGridColumn dataField="country3" headerText="Ctry" width="30" paddingLeft="0" textAlign="center" showDataTips="true" dataTipField="country" />
			  <mx:DataGridColumn dataField="rating" headerText="Rate" width="35" paddingRight="3" textAlign="right" />
			  <mx:DataGridColumn dataField="time" headerText="Time" width="40" paddingLeft="0" textAlign="center" />
			  <mx:DataGridColumn dataField="rated" headerText="R?" width="25" paddingLeft="0" textAlign="center" />
			  <mx:DataGridColumn dataField="handicap" headerText="Handicap" width="60" paddingLeft="0" textAlign="center" />
			 </mx:columns>
			</mx:DataGrid>
		</mx:VDividedBox>
		<mx:VBox>
			<mx:VDividedBox>
				<mx:DataGrid id="gameListGrid" width="570" height="220" change="_gameSelected();" rowHeight="21" doubleClickEnabled="true" doubleClick="_watchDialog();">
				 <mx:columns>
				  <mx:DataGridColumn dataField="gameNo" headerText="No." width="30" paddingLeft="0" textAlign="center" />
				  <mx:DataGridColumn dataField="blackRank" headerText="" width="55" paddingRight="2" textAlign="right" />
				  <mx:DataGridColumn dataField="blackFlagURL" headerText="" paddingLeft="0" paddingRight="0" itemRenderer="mx.controls.Image" width="27" resizable="false" />
				  <mx:DataGridColumn dataField="blackName" headerText="Black" width="100" paddingLeft="4"/>
				  <mx:DataGridColumn dataField="whiteName" headerText="White" width="100" paddingRight="4" textAlign="right"  />
				  <mx:DataGridColumn dataField="whiteFlagURL" headerText="" paddingLeft="0" paddingRight="0" itemRenderer="mx.controls.Image" width="27" resizable="false" />
				  <mx:DataGridColumn dataField="whiteRank" headerText="" width="55" paddingLeft="2" />
				  <mx:DataGridColumn dataField="rule" headerText="Rule" width="80" paddingLeft="3" showDataTips="true" dataTipField="hcTip" />
				  <mx:DataGridColumn dataField="status" headerText="Status" width="50" paddingLeft="2" />
				  <mx:DataGridColumn dataField="watchers" headerText="Mon."/>
				 </mx:columns>
				</mx:DataGrid>
				<mx:TextArea id="userMessage1" wordWrap="true" editable="false" width="570" height="215" fontSize="12" doubleClickEnabled="true" doubleClick="_playerInfoFromText(userMessage1);" /> <!-- height="185" -->
			</mx:VDividedBox>
			<mx:HBox>
				<mx:Label text="Chat"/>
				<mx:TextInput id="chatMessage1" width="430"/>
				<mx:CheckBox id="autoScrollCheck1" label="Auto-scroll" selected="true" click="_change_auto_scroll1();" />
			</mx:HBox>
		</mx:VBox>
	  </mx:HBox>
      </mx:Panel>
	  <mx:HBox paddingTop="5" fontSize="14" fontWeight="bold" width="975" horizontalAlign="center">
		  <mx:VBox horizontalAlign="center">
			  <mx:Label text="Los Angeles"/>
			  <mx:SWFLoader source="http://www.clocklink.com/clocks/5003-blue.swf?TimeZone=USA_LosAngeles" width="300" height="25"/>
		  </mx:VBox>
		  <mx:VBox horizontalAlign="center">
			  <mx:Label text="UTC"/>
			  <mx:SWFLoader source="http://www.clocklink.com/clocks/5003-green.swf?TimeZone=GMT" width="300" height="25"/>
		  </mx:VBox>
		  <mx:VBox horizontalAlign="center">
			  <mx:Label text="Tokyo"/>
			  <mx:SWFLoader source="http://www.clocklink.com/clocks/5003-red.swf?TimeZone=GMT0900" width="300" height="25"/>
		  </mx:VBox>
	  </mx:HBox>
	  <!-- <mx:Label text=" " doubleClickEnabled="true" doubleClick="_killGhost(chatMessage1.text);"/> -->
    </mx:VBox>

    <mx:HBox id="boardBox">
	<mx:Panel width="100%" height="100%" headerHeight="0" backgroundColor="#FFcccc" borderThicknessBottom="0" borderThicknessLeft="0" borderThicknessRight="0" borderThicknessTop="0" paddingLeft="0" paddingRight="0" backgroundAlpha="0">
	<mx:HBox paddingLeft="5" paddingTop="5">
      <mx:VBox>
      <eightyOneSquare:Board id="board" width="782" height="474"/> 
      <mx:HBox>
        <mx:Panel id="messagePanel" title="Message Panel" width="435" height="200" headerHeight="22">
        <mx:TextArea id="userMessage2" wordWrap="true" editable="false" width="415" height="166" fontSize="12" doubleClickEnabled="true" doubleClick="_playerInfoFromText(userMessage2);" />
        </mx:Panel>
        <mx:Panel id="controlPanel" title="Control Panel" width="340" height="200" verticalAlign="middle" paddingLeft="8" headerHeight="22">
          <mx:HBox>
            <mx:Button id="resignButton" label="Resign" click="_resignAlert();"/>
            <mx:Button id="optionButton2" label="Options" click="_showOptions();"/>
            <mx:Button id="impasseButton" label="Impasse?" click="_showImpasse();"/>
            <mx:Button id="closeButton" label="Close" click="_closeGame();" enabled="false"/>           
          </mx:HBox>
          <mx:HBox>
            <mx:Button id="rewindAllButton" label="|&lt;" enabled="false" click="replayByButton(-2);"/>
            <mx:Button id="rewindOneButton" label="&lt;" enabled="false" click="replayByButton(-1);"/>    
            <mx:Button id="forwardOneButton" label=">" enabled="false" click="replayByButton(1);"/>
            <mx:Button id="forwardAllButton" label=">|" enabled="false" click="replayByButton(2);"/>
          </mx:HBox>
         <mx:Label text="Chat"/>
         <mx:TextInput id="chatMessage2" width="300"/>
		 <mx:HBox>
			<mx:CheckBox id="autoScrollCheck2" label="Auto-scroll" selected="true" click="_change_auto_scroll2();" />
			<mx:Button id="checkLobbyButton" label="Check Lobby" enabled="true" click="_checkLobby();" />
			<mx:CheckBox id="muteCheck2" label="Mute" click="_mute(muteCheck2.selected)"/>
		</mx:HBox>
        </mx:Panel>
      </mx:HBox>
      </mx:VBox>
        <mx:Panel id="sidePanel" title="Side Panel" width="180" height="680" headerHeight="22">
		<mx:HBox paddingBottom="-2">
          <mx:Label id="watcherListTitle" text="Watchers (0)" fontWeight="bold" paddingRight="0" />
		  <mx:Button id="refreshWatchersButton" label="Refresh" fontSize="9" click="_refresh();"/>
		</mx:HBox>
		<mx:DataGrid id="watcherListGrid" width="160" height="234" rowHeight="21" doubleClickEnabled="true" doubleClick="_openPlayerInfo(_findPlayerFromList(watcherListGrid.selectedItem.name));">
         <mx:columns>
          <mx:DataGridColumn dataField="name" headerText="Name" width="80" paddingLeft="2" />
		  <mx:DataGridColumn dataField="country3" headerText="Ctry" width="40" paddingLeft="2" textAlign="center" showDataTips="true" dataTipField="country" />
		  <mx:DataGridColumn dataField="rating" headerText="Rate" width="40" paddingRight="3" textAlign="right" />
         </mx:columns>
        </mx:DataGrid>
		<mx:HBox paddingBottom="-2">
			<mx:Label text="Kifu" fontWeight="bold"/>
			<mx:Button id="kifuCopyButton" label="Copy" click="System.setClipboard(_formatKIF());" enabled="false"/>
			<mx:Button id="kifuSaveButton" label="Save" click="_saveKIF();" enabled="false" />
		</mx:HBox>
        <mx:DataGrid id="kifuDataGrid" sortableColumns="false" width="160" height="322" change="kifuListSelected();" selectable="false" fontSize="10" rowHeight="20">
         <mx:columns>
          <mx:DataGridColumn headerText="No." dataField="num" width="35"/>
          <mx:DataGridColumn dataField="move"/>
         </mx:columns>
        </mx:DataGrid>
        <mx:HBox paddingTop="-3">
			<mx:RadioButtonGroup id="RadioGroupKifu" change="_toggleListen();" />
			<mx:RadioButton id="radioKifuReplay" groupName="RadioGroupKifu" label="Replay" />
			<mx:RadioButton id="radioKifuListen" groupName="RadioGroupKifu" label="Listen"/>
        </mx:HBox>
        </mx:Panel>
	</mx:HBox>
	</mx:Panel>
    </mx:HBox>

	<mx:VBox paddingLeft="10" paddingTop="10">
    <mx:Panel id="searchPanel" title="Search Panel" paddingLeft="10" paddingTop="10" paddingBottom="10" paddingRight="10">
	  <mx:HBox>
		<mx:Accordion id="searchAccordion" width="680" height="560">
			<mx:HBox label="Kifu Search" paddingTop="8" paddingLeft="8" width="700" height="530">
				<mx:VBox>
					<mx:HBox>
						<mx:Button id="searchKifuButton" label="Search" click="_sendKifuSearch();" />
						<mx:Button label="Close" click="mainViewStack.selectedIndex=1;" />
					</mx:HBox>
					<mx:HBox>
						<mx:Label text="Player Name"/>
						<mx:TextInput id="kifuSearchPlayerText" width="90" />
					</mx:HBox>
					<mx:Label text="From"/>
					<mx:DateChooser id="kifuSearchFromChooser" />
					<mx:Label text="To"/>
					<mx:DateChooser id="kifuSearchToChooser" />
				</mx:VBox>
				<mx:DataGrid id="kifuSearchGrid" width="470" height="470" rowHeight="21" doubleClickEnabled="true" doubleClick="_kifuSearchSelected();">
					<mx:columns>
					<mx:DataGridColumn dataField="black" headerText="Black" width="110" />
					<mx:DataGridColumn dataField="white" headerText="White" width="110" />
					<mx:DataGridColumn dataField="winner" headerText="Winner" width="50" />
					<!-- <mx:DataGridColumn dataField="moves" headerText="Moves" width="45" /> -->
					<mx:DataGridColumn dataField="rule" headerText="Rules" width="110" />
					<mx:DataGridColumn dataField="date" headerText="Date"/>
					</mx:columns>
				</mx:DataGrid>
			</mx:HBox>
			<mx:VBox label="Player Search" paddingTop="10" paddingLeft="10" width="700" height="530">
				<mx:HBox>
					<mx:Label text="Name"/>
					<mx:TextInput id="playerSearchNameText"/>
					<mx:Button id="searchPlayerButton" label="Search" click="_sendPlayerSearch();" />
					<mx:Button label="Close" click="mainViewStack.selectedIndex=1;" />
				</mx:HBox>
				<mx:DataGrid id="playerSearchGrid" width="630" height="440" rowHeight="21">
					<mx:columns>
					<mx:DataGridColumn dataField="title" headerText="Title" width="50" />
					<mx:DataGridColumn dataField="rank" headerText="Rank" width="50" />
					<mx:DataGridColumn dataField="login" headerText="Name" width="110" />
					<mx:DataGridColumn dataField="flagURL" headerText="" paddingLeft="0" paddingRight="0" itemRenderer="mx.controls.Image" width="27" resizable="false" />
					<mx:DataGridColumn dataField="country" headerText="Country" width="90" />
					<mx:DataGridColumn dataField="rate" headerText="Rating" width="50" textAlign="right" />
					<mx:DataGridColumn dataField="wins" headerText="Win" width="45" textAlign="right" />
					<mx:DataGridColumn dataField="total" headerText="Total" width="45" textAlign="right" />
					<mx:DataGridColumn dataField="losses" headerText="Loss" width="45" textAlign="right" />
					<mx:DataGridColumn dataField="percentage" headerText="Percentage" width="45" textAlign="right" />
					<mx:DataGridColumn dataField="streak_best" headerText="Best Streak" textAlign="right" />
					</mx:columns>
				</mx:DataGrid>
			</mx:VBox>
			<mx:HBox label="View Rankings" paddingTop="10" paddingLeft="10" width="700" height="530">
				<mx:VBox>
					<mx:Button id="searchRankingButton" label="Search" click="_sendRankingSearch();" />
					<mx:Button label="Close" click="mainViewStack.selectedIndex=1;" />
				</mx:VBox>
				<mx:TabNavigator id="rankingTabNavigator" paddingTop="8" paddingLeft="8" width="580" height="480">
					<mx:VBox label="Rating">
						<mx:DataGrid id="rateRankingGrid" width="550" height="440" rowHeight="21" >
							<mx:columns>
							<mx:DataGridColumn dataField="number" headerText="No." width="28" textAlign="center" />
							<mx:DataGridColumn dataField="rate" headerText="Rating" width="55" textAlign="right" paddingRight="5" fontWeight="bold" fontSize="12" />
							<mx:DataGridColumn dataField="login" headerText="Name" width="100" />
							<mx:DataGridColumn dataField="flagURL" headerText="" paddingLeft="0" paddingRight="0" itemRenderer="mx.controls.Image" width="27" resizable="false" />
							<mx:DataGridColumn dataField="country" headerText="Country" width="90" />
							<mx:DataGridColumn dataField="title" headerText="Title" width="45" />
							<mx:DataGridColumn dataField="rank" headerText="Rank" width="45" />
							<mx:DataGridColumn dataField="wins" headerText="Win" width="45" textAlign="right" paddingRight="5" />
							<mx:DataGridColumn dataField="losses" headerText="Loss" width="45" textAlign="right" paddingRight="5" />
							<mx:DataGridColumn dataField="percentage" headerText="Percentage" textAlign="right" paddingRight="5" />
							</mx:columns>
						</mx:DataGrid>
					</mx:VBox>
					<mx:VBox label="Wins">
						<mx:DataGrid id="winRankingGrid" width="550" height="440" rowHeight="21">
							<mx:columns>
							<mx:DataGridColumn dataField="number" headerText="No." width="28" textAlign="center" />
							<mx:DataGridColumn dataField="wins" headerText="Win" width="55" textAlign="right" paddingRight="5" fontWeight="bold" fontSize="12" />
							<mx:DataGridColumn dataField="login" headerText="Name" width="100" />
							<mx:DataGridColumn dataField="flagURL" headerText="" paddingLeft="0" paddingRight="0" itemRenderer="mx.controls.Image" width="27" resizable="false" />
							<mx:DataGridColumn dataField="country" headerText="Country" width="90" />
							<mx:DataGridColumn dataField="title" headerText="Title" width="45" />
							<mx:DataGridColumn dataField="rank" headerText="Rank" width="45" />
							<mx:DataGridColumn dataField="total" headerText="Total" width="45" textAlign="right" paddingRight="5" />
							<mx:DataGridColumn dataField="percentage" headerText="Percentage" width="45" paddingRight="5" textAlign="right" />
							<mx:DataGridColumn dataField="rate" headerText="Rating" textAlign="right" paddingRight="5"/>
							</mx:columns>
						</mx:DataGrid>
					</mx:VBox>
					<mx:VBox label="Winning Percentage">
						<mx:DataGrid id="percentageRankingGrid" width="550" height="440" rowHeight="21">
							<mx:columns>
							<mx:DataGridColumn dataField="number" headerText="No." width="28" textAlign="center" />
							<mx:DataGridColumn dataField="percentage" headerText="Percentage" width="55" textAlign="right" paddingRight="5" fontWeight="bold" fontSize="12" />
							<mx:DataGridColumn dataField="login" headerText="Name" width="100" />
							<mx:DataGridColumn dataField="flagURL" headerText="" paddingLeft="0" paddingRight="0" itemRenderer="mx.controls.Image" width="27" resizable="false" />
							<mx:DataGridColumn dataField="country" headerText="Country" width="90" />
							<mx:DataGridColumn dataField="title" headerText="Title" width="45" />
							<mx:DataGridColumn dataField="rank" headerText="Rank" width="45" />
							<mx:DataGridColumn dataField="wins" headerText="Win" width="45" textAlign="right" paddingRight="5" />
							<mx:DataGridColumn dataField="total" headerText="Total" width="45" textAlign="right" paddingRight="5" />
							<mx:DataGridColumn dataField="rate" headerText="Rating" textAlign="right" paddingRight="5"/>
							</mx:columns>
						</mx:DataGrid>
					</mx:VBox>
					<mx:VBox label="Best Streak">
						<mx:DataGrid id="streakRankingGrid" width="550" height="440" rowHeight="21">
							<mx:columns>
							<mx:DataGridColumn dataField="number" headerText="No." width="28" textAlign="center" />
							<mx:DataGridColumn dataField="streak_best" headerText="Best Streak" width="55" textAlign="right" paddingRight="5" fontWeight="bold" fontSize="12" />
							<mx:DataGridColumn dataField="login" headerText="Name" width="100" />
							<mx:DataGridColumn dataField="flagURL" headerText="" paddingLeft="0" paddingRight="0" itemRenderer="mx.controls.Image" width="27" resizable="false" />
							<mx:DataGridColumn dataField="country" headerText="Country" width="90" />
							<mx:DataGridColumn dataField="title" headerText="Title" width="45" />
							<mx:DataGridColumn dataField="rank" headerText="Rank" width="45" />
							<mx:DataGridColumn dataField="wins" headerText="Win" width="45" textAlign="right" paddingRight="5" />
							<mx:DataGridColumn dataField="losses" headerText="Loss" width="45" textAlign="right" paddingRight="5" />
							<mx:DataGridColumn dataField="rate" headerText="Rating" textAlign="right" paddingRight="5"/>
							</mx:columns>
						</mx:DataGrid>
					</mx:VBox>
					<mx:VBox label="Total Games">
						<mx:DataGrid id="totalRankingGrid" width="550" height="440" rowHeight="21">
							<mx:columns>
							<mx:DataGridColumn dataField="number" headerText="No." width="28" textAlign="center" />
							<mx:DataGridColumn dataField="total" headerText="Total" width="55" textAlign="right" paddingRight="5" fontWeight="bold" fontSize="12" />
							<mx:DataGridColumn dataField="login" headerText="Name" width="100" />
							<mx:DataGridColumn dataField="flagURL" headerText="" paddingLeft="0" paddingRight="0" itemRenderer="mx.controls.Image" width="27" resizable="false" />
							<mx:DataGridColumn dataField="country" headerText="Country" width="90" />
							<mx:DataGridColumn dataField="title" headerText="Title" width="45" />
							<mx:DataGridColumn dataField="rank" headerText="Rank" width="45" />
							<mx:DataGridColumn dataField="wins" headerText="Win" width="45" textAlign="right" paddingRight="5" />
							<mx:DataGridColumn dataField="losses" headerText="Loss" width="45" textAlign="right" paddingRight="5" />
							<mx:DataGridColumn dataField="rate" headerText="Rating" textAlign="right" paddingRight="5" />
							</mx:columns>
						</mx:DataGrid>
					</mx:VBox>
				</mx:TabNavigator>
			</mx:HBox>
		</mx:Accordion>
	  </mx:HBox>
    </mx:Panel>
    </mx:VBox>
  </mx:ViewStack>

</mx:Application>
